{
  "title": "Square Candy - Server Overview",
  "uid": "sqcdy-server-overview",
  "tags": ["squarecandy", "server", "infrastructure"],
  "links": [
    {"title": "Server Overview", "type": "link", "url": "/d/sqcdy-server-overview", "keepTime": true, "includeVars": true, "icon": "cloud"},
    {"title": "Site Metrics", "type": "link", "url": "/d/sqcdy-site-drilldown", "keepTime": true, "includeVars": true, "icon": "dashboard"},
    {"title": "User Metrics", "type": "link", "url": "/d/sqcdy-user-metrics", "keepTime": true, "includeVars": true, "icon": "info"},
    {"title": "Log Viewer", "type": "link", "url": "/d/sqcdy-log-viewer", "keepTime": true, "includeVars": true, "icon": "doc"}
  ],
    "timezone": "browser",
    "schemaVersion": 38,
    "version": 7,
    "refresh": "30s",
    "time": {
      "from": "now-6h",
      "to": "now"
    },
    "templating": {
      "list": [
        {
          "name": "server",
          "type": "query",
          "query": "label_values(sqcdy_sites_total, instance)",
          "current": {},
          "refresh": 1,
          "includeAll": true,
          "multi": false,
          "sort": 1
        }
      ]
    },
    "panels": [
      {
        "title": "CPU Usage %",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
        "targets": [
          {
            "expr": "label_replace(100 - (avg by (instance) (irate(node_cpu_seconds_total{mode=\"idle\",instance=~\"$server.*\"}[$__rate_interval])) * 100), \"instance\", \"$1\", \"instance\", \"([^:]+)(:[0-9]+)?\")",
            "legendFormat": "{{instance}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "min": 0,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 70, "color": "yellow"},
                {"value": 90, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "title": "Load Average",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
        "targets": [
          {
            "expr": "label_replace(node_load1{instance=~\"$server.*\"}, \"instance\", \"$1\", \"instance\", \"([^:]+)(:[0-9]+)?\")",
            "legendFormat": "{{instance}} - 1m",
            "refId": "A"
          },
          {
            "expr": "label_replace(node_load5{instance=~\"$server.*\"}, \"instance\", \"$1\", \"instance\", \"([^:]+)(:[0-9]+)?\")",
            "legendFormat": "{{instance}} - 5m",
            "refId": "B"
          },
          {
            "expr": "label_replace(node_load15{instance=~\"$server.*\"}, \"instance\", \"$1\", \"instance\", \"([^:]+)(:[0-9]+)?\")",
            "legendFormat": "{{instance}} - 15m",
            "refId": "C"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "short"
          }
        }
      },
      {
        "title": "CPU Steal",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
        "targets": [
          {
            "expr": "label_replace(avg by (instance) (irate(node_cpu_seconds_total{mode=\"steal\",instance=~\"$server.*\"}[$__rate_interval])) * 100, \"instance\", \"$1\", \"instance\", \"([^:]+)(:[0-9]+)?\")",
            "legendFormat": "{{instance}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 5, "color": "yellow"},
                {"value": 10, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "title": "Memory Usage",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
        "targets": [
          {
            "expr": "label_replace(100 * (1 - (node_memory_MemAvailable_bytes{instance=~\"$server.*\"} / node_memory_MemTotal_bytes{instance=~\"$server.*\"})), \"instance\", \"$1\", \"instance\", \"([^:]+)(:[0-9]+)?\")",
            "legendFormat": "{{instance}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "min": 0,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 80, "color": "yellow"},
                {"value": 95, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "title": "Swap Usage",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
        "targets": [
          {
            "expr": "label_replace(100 * (1 - (node_memory_SwapFree_bytes{instance=~\"$server.*\"} / node_memory_SwapTotal_bytes{instance=~\"$server.*\"})), \"instance\", \"$1\", \"instance\", \"([^:]+)(:[0-9]+)?\")",
            "legendFormat": "{{instance}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "min": 0,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 50, "color": "yellow"},
                {"value": 80, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "title": "Disk Utilization %",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
        "targets": [
          {
            "expr": "label_replace(100 - (100 * node_filesystem_avail_bytes{mountpoint=\"/\",instance=~\"$server.*\"} / node_filesystem_size_bytes{mountpoint=\"/\",instance=~\"$server.*\"}), \"instance\", \"$1\", \"instance\", \"([^:]+)(:[0-9]+)?\")",
            "legendFormat": "{{instance}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "min": 0,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {"value": 0, "color": "green"},
                {"value": 80, "color": "yellow"},
                {"value": 90, "color": "red"}
              ]
            }
          }
        }
      },
      {
        "title": "Traffic: Requests per Minute",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
        "targets": [
          {
            "expr": "sum by (instance) (rate(sqcdy_site_requests_total{instance=~\"$server\"}[$__rate_interval])) * 60",
            "legendFormat": "{{instance}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "reqpm"
          }
        }
      },
      {
        "title": "Traffic: MB per Minute",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
        "targets": [
          {
            "expr": "sum by (instance) (rate(sqcdy_site_traffic_bytes{instance=~\"$server\"}[$__rate_interval])) * 60 / 1024 / 1024",
            "legendFormat": "{{instance}}",
            "refId": "A"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "MBs"
          }
        }
      }
    ]
}
